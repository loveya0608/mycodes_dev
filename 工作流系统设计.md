# 工作流系统设计

## 1. 业务系统开发流程

![](assets/2018-07-20-09-15-24.png)

 - 业务系统只开发处理最终数据的逻辑，对于流程中间步骤（如申请、复核、审批等）不关心
 - 表单页面由业务系统开发人员按工作流系统所给出的配置说明进行配置
 - 业务系统开发人员可选择通过第三方或直接使用工作流系统进行流程模型的设计与配置

## 2. 交互设计

![](assets/2018-07-20-09-14-58.png)

 - 用户办理业务时通过工作流系统完成
 - 用户并不是完全不使用业务系统，对于查询、报表、存续期间管理等业务仍归业务系统处理
 - 业务系统需要接收工作流系统传递的业务事实并进行处理
 - 业务系统可能需要提供查询接口供表单页面展示数据

## 3. 工作流系统整体框架

![整体架构](assets/2018-07-16-09-15-13.jpg)



## 4. 整体技术面的目标

### 减少业务系统改造工作量

1.  假设业务系统在未加上工作流之前，对业务办理处理过程为：

    > 1.  打开页面
    > 2.  录入信息
    > 3.  保存至后台

2.  为了在接入工作流的过程中，减少业务系统的改造工作量：

    > 1.  业务系统本身不关注工作流
    > 2.  整个流程的生命周期都应在工作流系统中完成
    > 3.  最终的业务数据归业务系统处理

### 不与语言绑定，支持异构

1.  若工作流系统是以 jar lib 方式与业务系统进行集成，则业务系统将局限在 Java 语言内。
2.  以 http 协议作为工作流系统与业务系统通讯的标准，则业务系统可以是 python、php、golang 等实现。

### 规避事务问题

假设一个完整业务流程有多个任务组成。若是由业务系统在每次的任务办理中操作自身的数据，再调用工作流的 API。如果出现事务不一致：

- 1.  业务系统使用 TCC、LCN 等技术与工作流系统进行事务一致性控制 - 2. 或者，除了开发正向操作的代码，同时还要开发撤销、冲正的逻辑 - 3. 转而使用嵌入式工作流的方式，而工作流系统则转变为一个单纯的管理端。

---

## 5. 系统间交互时序

![](assets/2018-07-20-09-15-55.png)

1.  业务系统完全不引用工作流的 lib。
2.  流程结束前的操作全部在工作流系统中完成。
3.  流程处理过程中的表单页面通过表单引擎进行配置化。
4.  流程结束后,数据才会给业务系统。
5.  对于业务系统来说，与接入工作流之前相比，没有太大区别。

    > 接入工作流之前：数据由用户在本系统页面中录入提交至后台

    > 接入工作流之后：数据由工作流系统从接口传入提交至后台

### 约定名词概念

1.  fact 业务事实： 流程结束后传递给业务系统的数据。
2.  flyway 游离状态： 流程在处理中，业务系统不需要知道工作流到底走到哪一步了。对于业务系统来说，仅知道有一笔数据此时处理 flyway 状态。
3.  landing 落地状态：流程已走完，将结果数据传递给业务系统，对于业务系统来说，此时数据落地，处于 landing 状态。

![](assets/2018-07-20-09-05-19.png)

## 6. 表单引擎

### 6.1 表单页面配置示例

```json
 {
    "name": "apply",
    "version": 1,
    "description": "预付款申请页面",
    "key": "apply-form",
    "category": "prepayments",
    "content": [
       {
        "gutter": 20,
        "list": [
            {
                "span": 12,
                "type": "input",
                "label": "姓名",
                "disable": false,
                "readonly": false,
                "placeholder": "请输入姓名",
                "rules": [],
                "key": "name",
                "subtype": "text",
                "show":true,
                "casecade":{
                    "event":"change",
                    "keys":["casecade1","casecade2"],
                    "rule":["flag+'casecade1'","flag+'casecade2'"]
                }
            },
            {
                "span": 12,
                "type": "radio",
                "label": "性别",
                "button": false,
                "border": true,
                "rules": [],
                "key": "gender",
                "options": [
                    {
                        "value": "1",
                        "label": "男",
                        "disabled": false
                    },
                    {
                        "value": "0",
                        "label": "女",
                        "disabled": false
                    }
                ],
                "show":true
            }
        ]
    },
    {
        "gutter": 20,
        "list": [
            {
                "span": 12,
                "type": "input",
                "label": "casecade1",
                "disable": false,
                "readonly": false,
                "placeholder": "casecade1",
                "rules": [],
                "key": "casecade1",
                "subtype": "text",
                "show":true
            },
            {
                "span": 12,
                "type": "input",
                "label": "casecade2",
                "disable": false,
                "readonly": false,
                "placeholder": "casecade2",
                "rules": [],
                "key": "casecade2",
                "subtype": "text",
                "show":true
            }
        ]
    },
    {
        "gutter": 20,
        "list": [
            {
                "span": 12,
                "type": "switch",
                "label": "switch",
                "disable": false,
                "readonly": false,
                "rules": [],
                "key": "switch_test",
                "defaultValue":true,
                "casecade":{
                    "event":"show",
                    "keys":["casecade1","casecade2"],
                    "rule":"flag==true"
                },
                "show":true
            } 
        ]
    }
    ]
}

```

### 6.2 配置文件字段说明

#### 表单页面属性

| name        | 描述                                                                                                                   |
| ----------- | ---------------------------------------------------------------------------------------------------------------------- |
| name        | 表单标题                                                                                                               |
| version     | 表单版本号                                                                                                             |
| description | 表单描述                                                                                                               |
| key         | 表单的 key（同类表单唯一，版本号，递增，如用户基本信息表单可对应多个版本号）                                           |
| category    | 表单种类，与工作流流程相对应                                                                                           |
| content     | 表单主体内容 ，由多个 键值为gutter和list的json组成，eg:[   {"gutter": 20,"list": [{"span": 12,...},{"span": 12,...}]}] |
| gutter      | 单行控件之间的间距                                                                                                     |
| list        | 单行控件集合，JsonArray数组，每个数组对应当前控件的属性信息   eg:[{"span":12,"type":"input","label":"姓名",...}]       |

#### 字段属性
带星号的为必需字段  

| name        | 二级属性名称 | 描述                                              | 默认值 |     |
| ----------- | ------------ | ------------------------------------------------- | ------ | --- |
| span        |              | 控件所占的栅格数（控件长度）                      |        |     |
| type        |              | 该字段的类型值（参照字段类型定义表）              |        |     |
| label       |              | 该字段的名称（用于显示的标签）                    |        |     |
| disable     |              | 该字段是否可见                                    | true   |     |
| readonly    |              | 该字段是否可编辑                                  | false  |     |
| placeholder |              | 空白时的输入提示                                  |        |     |
| *key        |              | 字段的key，推荐首字母小写，多个单词采用驼峰命名。 |        |     |
| required    |              | 该字段是否为必填字段                              | false  |     |
| value       |              | 字段默认值                                        | null   |     |
| rules       |              | 控件合法性验证                                    | null   |     |
| casecade    |              | 控件之间级联(参照级联属性表)                      | null   |     |

#### 控件级联属性表

| name  | 描述                                                                                        |
| ----- | ------------------------------------------------------------------------------------------- |
| event | 级联事件 eg:[change,show...]                                                                |
| keys  | 被动触发的控件所对应的key,数组格式，可以是多个 ,eg:  ["keys":["casecade1","casecade2"],...] |
| rule  | 级联规则                                                                                    |

#### 表单字段输入类型

| name             | 二级配置 | 描述                                                                     | 默认值     |     |
| ---------------- | -------- | ------------------------------------------------------------------------ | ---------- | --- |
| text             |          | 单行文本                                                                 |            |     |
| number           |          | 数字                                                                     |            |     |
| textarea         |          | 文本框，该类型字段在输入时为多行输入                                     |            |     |
| select           |          | 下拉选择，可根据用户的输入查询备选项，最后保存选项的值（不保存选项文本） |            |     |
| radio            |          | 单选框                                                                   |            |     |
| SelectWidthInput |          | 带有input输入框的下拉选择类型                                            | 参见select |     |
| selectWithAdd    |          | 可新增选项到远程服务器的下拉框                                           |            |     |
| date             |          | 日期，通过一个日期选择器选择日期或时间，统一存储为单位为毫秒的unix时间戳 |            |     |
| subform          |          | 子字段组类型，配置为此类型后，必须配置fields字段                         |            |     |
| address          |          | 地址选择                                                                 |            |     |

### 6.3 表单数据处理逻辑

![](assets/2018-07-16-16-56-58.png)

    - 将外部配置文件转为内部格式存储至数据库。有版本号概念。
    - 流程定义中，关联表单配置，但不指定版本号。
    - 运行时，使用最新版本号的表单配置，但使用后，需要将本次业务办理所用的表单版本号记录下来。
    - 在进行历史查询时，查找出任务办理时所用的表单版本进行反显。

### 6.4 表单数据存储

工作流系统不记录业务系统的数据模型，对所有的业务数据以序列化数据格式存储。
若后期有统计分析类的需要，则可选择以 json 格式存入 mongodb 中。


## 7. 推荐表结构设计

### 业务系统系统交互表

| 字段名       | 含义                     | 用途                                               |
| ------------ | ------------------------ | -------------------------------------------------- |
| business_key | 业务标识                 | 唯一标识出一笔业务，在整个业务流程的生命周期中不变 |
| statue       | 状态                     | 可选值：start;flyway;landing;complete              |
| init_data    | 发起流程的请求数据       | 业务系统在发起流程时传递给工作流系统               |
| final_data   | 流程结束后输出的业务事实 | 流程结束后，工作流系统传递给业务系统               |

### 工作流系统中对应的表结构

| 字段名       | 含义                     | 用途                                                             |
| ------------ | ------------------------ | ---------------------------------------------------------------- |
| business_key | 业务标识                 | 唯一标识出一笔业务，在整个业务流程的生命周期中不变               |
| statue       | 状态                     | 可选值：start;flyway;landing;complete                            |
| init_data    | 发起流程的请求数据       | 业务系统在发起流程时传递给工作流系统                             |
| final_data   | 流程结束后输出的业务事实 | 流程结束后，工作流系统传递给业务系统                             |
| system_id    | 系统标识                 | 一个工作流系统可服务多个业务系统，用此字段区分不同业务系统的数据 |


### 业务系统对交互表的操作

**业务系统接收到业务事实后，插入系统交互表**

| 字段         | 值                               |
| ------------ | -------------------------------- |
| business_key | 001                              |
| statue       | landing                          |
| init_data    | {user:'xxx':createTime:'xxx'...} |
| final_data   | {fact....}                       |

**业务系统按接收到的业务事实进行业务处理**

_若处理出错，可按系统交互表中记录的 final_date 重试_

**业务系统处理完后，更新系统交互表**

| 字段         | 值                               |
| ------------ | -------------------------------- |
| business_key | 001                              |
| statue       | complete                         |
| init_data    | {user:'xxx':createTime:'xxx'...} |
| final_data   | {fact....}                       |

## 8. 夜间批量对账

在工作流系统和业务系统中都有系统交互表

| 字段名       | 含义                     | 用途                                               |
| ------------ | ------------------------ | -------------------------------------------------- |
| business_key | 业务标识                 | 唯一标识出一笔业务，在整个业务流程的生命周期中不变 |
| statue       | 状态                     | 可选值：start;flyway;landing;complete              |
| init_data    | 发起流程的请求数据       | 业务系统在发起流程时传递给工作流系统               |
| final_data   | 流程结束后输出的业务事实 | 流程结束后，工作流系统传递给业务系统               |

为了避免系统间数据不一致，可对系统交互表进行批量对账。

### 对账过程

1.  业务系统将当日系统交互表的数据传给工作流系统批量程序

可以是业务系统主动传输，也可以工作流系统主动拉取。或是通过 ftp、NAS 等进行传输。

2.  核对总笔数是否一致
3.  逐笔核对业务标识与状态是否一致
4.  逐笔核对请求数据 init_date 是否一致
5.  逐笔核对业务事实数据 final_data 是否一致
